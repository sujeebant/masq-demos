(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{105:function(e,t,n){(function(t){var r=n(5),s=n(57),a=n(58),i=n(59),o=n(121),c=n(148),u=n(149),l=n(152),p=n(155),h=n(257),f=function(){},d=function(e){var t={};return o.WEBRTC_SUPPORT&&(t.wrtc=n(260)),t.config=h.SWARM_CONFIG,console.log(JSON.stringify(h)),o(e,t)},g=function(){"use strict";function e(t,n,r){a(this,e),this._reset(),this.appName=t,this.appDescription=n,this.appImageURL=r,this.userId=null,this.userAppDb=null,this._loadSessionInfo(),this.loginChannel=null,this.loginKey=null,this.loginUrl=null}return i(e,[{key:"_reset",value:function(){this.userAppRepSW=null,this.userAppRepHub=null,this._logIntoMasqErr=null,this._logIntoMasqDone=!1}},{key:"isLoggedIn",value:function(){return!!this.userId}},{key:"isConnected",value:function(){return!!this.userAppDb}},{key:"connectToMasq",value:function(){var e=s(r.mark(function e(){var t;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isLoggedIn()){e.next=4;break}return e.next=3,this._disconnect();case 3:throw Error("Not logged into Masq");case 4:return t=p.utils.createPromisifiedHyperDB(this.userId),this.userAppDb=t,e.next=8,p.utils.dbReady(t);case 8:this._startReplication();case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_disconnect",value:function(){var e=s(r.mark(function e(){var t=this;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise(function(e){if(t.userAppDb=null,!t.userAppRepSW)return t._reset(),void e();t.userAppRepSW.close(function(){t._reset(),e()})});case 2:return e.next=4,this._deleteSessionInfo(!1);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"signout",value:function(){var e=s(r.mark(function e(){return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.userId=null,this.userAppDb=null,e.next=4,this._disconnect();case 4:this._deleteSessionInfo(!0);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_deleteSessionInfo",value:function(e){e&&window.localStorage.removeItem("userId"),window.sessionStorage.removeItem("userId")}},{key:"_storeSessionInfo",value:function(e,t){e&&window.localStorage.setItem("userId",t),window.sessionStorage.setItem("userId",t)}},{key:"_loadSessionInfo",value:function(){var e=window.sessionStorage.getItem("userId");if(e)this.userId=e;else{var t=window.localStorage.getItem("userId");t&&(this.userId=t,window.sessionStorage.setItem("userId",this.userId))}}},{key:"_initSwarmWithDataHandler",value:function(){var e=s(r.mark(function e(t,n){return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(e,r){f("Creation of a hub with ".concat(t," channel name"));var s=c(t,h.HUB_URLS),a=d(s);console.log("channel init: "+t),a.on("peer",function(e,r){f("The peer ".concat(r," join us...")),console.log("peer connected : "+t),e.on("data",function(t){n(a,e,t)})}),a.on("disconnect",function(e,t){a.close()}),a.on("close",function(){e()})}));case 1:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"_startReplication",value:function(){var e=this,t=this.userAppDb.discoveryKey.toString("hex");console.log("start replication : "+t),this.userAppRepHub=c(t,h.HUB_URLS),this.userAppRepSW=d(this.userAppRepHub),this.userAppRepSW.on("peer",function(){var t=s(r.mark(function t(n,s){var a;return r.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:a=e.userAppDb.replicate({live:!0}),l(n,a,n);case 2:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}())}},{key:"_isRegistered",value:function(){var e=s(r.mark(function e(t){return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",p.utils.dbExists(t));case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_requestUserAppRegister",value:function(){var e=s(r.mark(function e(t,n){var s,a;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s={msg:"registerUserApp",name:this.appName,description:this.appDescription,imageURL:this.appImageURL},e.next=3,p.crypto.encrypt(t,s,"base64");case 3:a=e.sent,n.send(JSON.stringify(a));case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"_requestWriteAccess",value:function(){var e=s(r.mark(function e(t,n,s){var a,i;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a={msg:"requestWriteAccess",key:s.toString("hex")},e.next=3,p.crypto.encrypt(t,a,"base64");case 3:i=e.sent,n.send(JSON.stringify(i));case 5:case"end":return e.stop()}},e,this)}));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_sendConnectionEstablished",value:function(){var e=s(r.mark(function e(t,n){var s,a;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s={msg:"connectionEstablished"},e.next=3,p.crypto.encrypt(t,s,"base64");case 3:a=e.sent,n.send(JSON.stringify(a));case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"_checkMessage",value:function(e,t,n,r){var s=!1,a=function(){r(),s=!0};switch(e.msg){case"authorized":e.userAppDbId||a();break;case"notAuthorized":break;case"masqAccessGranted":if(!t){a();break}if(!e.key){a();break}e.userAppDbId||a();break;case"masqAccessRefused":t||a();break;case"writeAccessGranted":n||a();break;default:a("Unexpectedly received message with type ".concat(e.msg))}return s}},{key:"getLoginLink",value:function(){var e=s(r.mark(function e(){var n,s,a;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.loginChannel=u(),e.next=3,p.crypto.genAESKey(!0,"AES-GCM",128);case 3:return this.loginKey=e.sent,e.next=6,p.crypto.exportKey(this.loginKey);case 6:return n=e.sent,s=t.from(n).toString("base64"),this.loginUrl=new URL(h.MASQ_APP_BASE_URL),"login",console.log("channel : "+this.loginChannel),console.log("key : "+s),a=JSON.stringify([this.appName,"login",this.loginChannel,s]),this.loginUrl.hash="/"+t.from(a).toString("base64"),e.abrupt("return",this.loginUrl.href);case 15:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"logIntoMasq",value:function(){var e=s(r.mark(function e(n){var a,i,o,c,u,l,h,f=this;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.userId&&this.signout(),n=!!n,a=this.loginChannel,i=this.loginKey,o=!1,c=!1,h=function(){var e=s(r.mark(function e(s,a,h){var d,g,v;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return d=function(e){f._logIntoMasqErr=Error(e),s.close()},e.prev=1,e.next=4,p.crypto.decrypt(i,JSON.parse(h),"base64");case 4:g=e.sent,e.next=14;break;case 7:if(e.prev=7,e.t0=e.catch(1),"Unsupported state or unable to authenticate data"!==e.t0.message){e.next=12;break}return d("Unable to read the message with the key sent to Masq-app"),e.abrupt("return");case 12:return d("Unknown error while decrypting: "+e.t0.message),e.abrupt("return");case 14:f._checkMessage(g,o,c,d),console.log("lib: message: "+JSON.stringify(g)),e.t1=g.msg,e.next="authorized"===e.t1?19:"notAuthorized"===e.t1?34:"masqAccessGranted"===e.t1?37:"masqAccessRefused"===e.t1?45:"writeAccessGranted"===e.t1?48:55;break;case 19:return u=g.userAppDbId,e.next=22,f._isRegistered(u);case 22:if(!e.sent){e.next=31;break}return f.userId=u,f._storeSessionInfo(n,u),e.next=27,f.connectToMasq();case 27:return e.next=29,f._sendConnectionEstablished(i,a);case 29:return s.close(),e.abrupt("return");case 31:case 34:return o=!0,f._requestUserAppRegister(i,a),e.abrupt("break",55);case 37:return o=!1,v=t.from(g.key,"hex"),l=p.utils.createPromisifiedHyperDB(u,v),e.next=42,p.utils.dbReady(l);case 42:return c=!0,f._requestWriteAccess(i,a,l.local.key),e.abrupt("break",55);case 45:return o=!1,d("Masq access refused by the user"),e.abrupt("return");case 48:return c=!1,f._storeSessionInfo(n,u),f.userId=u,f.userAppDb=l,f._startReplication(),s.close(),e.abrupt("break",55);case 55:case"end":return e.stop()}},e,this,[[1,7]])}));return function(t,n,r){return e.apply(this,arguments)}}(),this._initSwarmWithDataHandler(a,h).then(function(){f._logIntoMasqDone=!0,f._onLogIntoMasqDone&&f._onLogIntoMasqDone()}),e.abrupt("return",new Promise(function(e,t){if(f._logIntoMasqDone)return f._logIntoMasqDone=!1,f._logIntoMasqErr?t(f._logIntoMasqErr):e();f._onLogIntoMasqDone=function(){return f._onLogIntoMasqDone=void 0,f._logIntoMasqDone=!1,f._logIntoMasqErr?t(f._logIntoMasqErr):e()}}));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"_getDB",value:function(){if(!this.userAppDb)throw Error("Not connected to Masq");return this.userAppDb}},{key:"watch",value:function(e,t){return this._getDB().watch(e,function(){return t()})}},{key:"get",value:function(){var e=s(r.mark(function e(t){var n,s;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._getDB(),e.next=3,n.getAsync(t);case 3:if(s=e.sent){e.next=6;break}return e.abrupt("return",null);case 6:return e.abrupt("return",s.value);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=s(r.mark(function e(t,n){var s;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=this._getDB(),e.abrupt("return",s.putAsync(t,n));case 2:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"del",value:function(){var e=s(r.mark(function e(t){var n;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._getDB(),e.abrupt("return",n.delAsync(t));case 2:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"list",value:function(){var e=s(r.mark(function e(t){var n,s,a;return r.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._getDB(),e.next=3,n.listAsync(t);case 3:return s=e.sent,a=s.reduce(function(e,t){var n=Array.isArray(t)?t[0]:t;return e[n.key]=n.value,e},{}),e.abrupt("return",a);case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=g}).call(this,n(1).Buffer)},109:function(e,t,n){e.exports=n(272)},114:function(e,t,n){},133:function(e,t){},135:function(e,t){},154:function(e,t){},178:function(e,t){},257:function(e,t,n){var r={};console.log("prod"),r=n(259),e.exports=r},258:function(e){e.exports={MASQ_APP_BASE_URL:"http://localhost:3000/",HUB_URLS:["localhost:8080"],SWARM_CONFIG:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"}]}}},259:function(e){e.exports={MASQ_APP_BASE_URL:"https://masq-app-l2qamqx00.now.sh/build/",HUB_URLS:["wss://signalhub-jvunerwwrg.now.sh"],SWARM_CONFIG:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"},{urls:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"}]}}},268:function(e,t,n){},272:function(e,t,n){"use strict";n.r(t);var r=n(0),s=n.n(r),a=n(104),i=n.n(a),o=(n(114),n(108)),c=n(5),u=n.n(c),l=n(13),p=n(37),h=n(38),f=n(40),d=n(39),g=n(41),v=n(4),m=n(105),w=n.n(m),b=n(106),y=n(107),k=function(e){return s.a.createElement("svg",Object.assign({height:24,viewBox:"0 0 24 24",width:24},e),s.a.createElement("path",{fill:"currentColor",d:"M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"}),s.a.createElement("path",{d:"M0 0h24v24H0z",fill:"none"}))},x=function(e){function t(e){var n;return Object(p.a)(this,t),(n=Object(f.a)(this,Object(d.a)(t).call(this,e))).state={query:""},n.openQwant=n.openQwant.bind(Object(v.a)(Object(v.a)(n))),n.handleKeyPress=n.handleKeyPress.bind(Object(v.a)(Object(v.a)(n))),n.inputRef=s.a.createRef(),n}return Object(g.a)(t,e),Object(h.a)(t,[{key:"componentDidMount",value:function(){this.inputRef.current.focus()}},{key:"openQwant",value:function(){window.open("https://www.qwant.com/?q="+this.state.query)}},{key:"handleKeyPress",value:function(e){"Enter"===e.key&&(this.props.onSearch&&this.props.onSearch(this.state.query),this.openQwant())}},{key:"render",value:function(){var e=this;return s.a.createElement(y.a,{onStateChange:function(t){var n=t.inputValue;return n&&e.setState({query:n})},selectedItem:this.state.query,render:function(t){var n=t.getInputProps,r=t.getItemProps,a=t.isOpen,i=t.inputValue,o=t.highlightedIndex,c=t.selectedItem;return s.a.createElement("div",{className:"SearchBar"},s.a.createElement("div",null,s.a.createElement("input",Object.assign({},n({onKeyUp:e.handleKeyPress}),{className:"input",ref:e.inputRef,placeholder:"What are you looking for?"})),s.a.createElement(k,{onClick:e.openQwant,className:"icon"})),a&&s.a.createElement("div",{className:"downshift"},e.props.items.filter(function(e){return!i||e.includes(i)}).map(function(e,t){return s.a.createElement("div",Object.assign({className:"downshiftRow"},r({key:t,index:t,item:e,style:{backgroundColor:o===t?"lightgray":"white",fontWeight:c===e?"bold":"normal"}})),e)})))}})}}]),t}(s.a.Component),I=(n(268),"Qwant Search"),S="Qwant Search app integrated with Masq",_="https://fr.wikipedia.org/wiki/Qwant#/media/File:Qwant_new_logo_2018.svg",A=function(e){function t(e){var n;return Object(p.a)(this,t),(n=Object(f.a)(this,Object(d.a)(t).call(this,e))).state={items:[],loggedIn:null,err:null,link:"#",loggingIn:!1,stayConnected:!1},n.masq=null,n.onSearch=n.onSearch.bind(Object(v.a)(Object(v.a)(n))),n.handleClickLogin=n.handleClickLogin.bind(Object(v.a)(Object(v.a)(n))),n.handleClickLogout=n.handleClickLogout.bind(Object(v.a)(Object(v.a)(n))),n.getAllQueriesFromDB=n.getAllQueriesFromDB.bind(Object(v.a)(Object(v.a)(n))),n.handleStayConnectedChange=n.handleStayConnectedChange.bind(Object(v.a)(Object(v.a)(n))),n}return Object(g.a)(t,e),Object(h.a)(t,[{key:"getAllQueriesFromDB",value:function(){var e=Object(l.a)(u.a.mark(function e(){var t,n;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.masq.list();case 2:t=e.sent,n=Object.keys(t),this.setState({items:n});case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"componentDidMount",value:function(){var e=Object(l.a)(u.a.mark(function e(){var t;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.masq=new w.a(I,S,_),e.prev=1,!this.masq.isLoggedIn()){e.next=10;break}return e.next=5,this.masq.connectToMasq();case 5:return this.setState({loggedIn:!0}),e.next=8,this.getAllQueriesFromDB();case 8:e.next=14;break;case 10:return e.next=12,this.masq.getLoginLink();case 12:t=e.sent,this.setState({link:t,loggedIn:!1});case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(1),this.setState({err:e.t0});case 19:case"end":return e.stop()}},e,this,[[1,16]])}));return function(){return e.apply(this,arguments)}}()},{key:"onSearch",value:function(){var e=Object(l.a)(u.a.mark(function e(t){var n,r;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.loggedIn){e.next=2;break}return e.abrupt("return");case 2:if(!this.state.items.find(function(e){return e===t})){e.next=9;break}return e.next=5,this.masq.get(t);case 5:return n=e.sent,e.next=8,this.masq.put(t,n+1);case 8:return e.abrupt("return");case 9:return r=Object(o.a)(this.state.items).concat([t]),e.prev=10,e.next=13,this.masq.put(t,1);case 13:this.setState({items:r}),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(10),console.error(e.t0.message);case 19:case"end":return e.stop()}},e,this,[[10,16]])}));return function(t){return e.apply(this,arguments)}}()},{key:"handleClickLogin",value:function(){var e=Object(l.a)(u.a.mark(function e(){return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.link){e.next=2;break}return e.abrupt("return");case 2:return this.setState({loggingIn:!0}),e.prev=3,e.next=6,this.masq.logIntoMasq(this.state.stayConnected);case 6:return this.setState({loggedIn:!0}),e.next=9,this.getAllQueriesFromDB();case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(3),console.error(e.t0);case 14:this.setState({loggingIn:!1});case 15:case"end":return e.stop()}},e,this,[[3,11]])}));return function(){return e.apply(this,arguments)}}()},{key:"handleClickLogout",value:function(){var e=Object(l.a)(u.a.mark(function e(){var t;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.masq.getLoginLink();case 2:return t=e.sent,this.setState({link:t,loggedIn:!1,items:[]}),e.next=6,this.masq.signout();case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"handleStayConnectedChange",value:function(){var e=Object(l.a)(u.a.mark(function e(t){var n,r;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=t.target,r=n.checked,this.setState({stayConnected:r});case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this.state,t=e.items,n=e.loggedIn,r=e.link,a=e.loggingIn;return s.a.createElement("div",{className:"App"},null===n&&!a&&s.a.createElement("div",{href:"#"},"Loading"),!1===n&&!a&&s.a.createElement("div",{className:"Login"},s.a.createElement("div",{className:"stayConnected"},s.a.createElement("input",{name:"stayConnected",type:"checkbox",checked:this.state.stayConnected,onChange:this.handleStayConnectedChange}),s.a.createElement("label",{htmlFor:"stayConnected"},"stay connected")),s.a.createElement("a",{href:r,target:"_blank",rel:"noopener noreferrer",onClick:this.handleClickLogin},"Log Into Masq"),s.a.createElement(b,{value:r})),n&&!a&&s.a.createElement("a",{href:"#",onClick:this.handleClickLogout},"Logout"),a&&s.a.createElement("div",null,"Logging In"),s.a.createElement(x,{onSearch:this.onSearch,items:t}))}}]),t}(r.Component),q=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function C(e){navigator.serviceWorker.register(e).then(function(e){e.onupdatefound=function(){var t=e.installing;t.onstatechange=function(){"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))}}}).catch(function(e){console.error("Error during service worker registration:",e)})}n(270);i.a.render(s.a.createElement(A,null),document.getElementById("root")),function(){if("serviceWorker"in navigator){if(new window.URL("/search/build",window.location).origin!==window.location.origin)return;window.addEventListener("load",function(){var e="".concat("/search/build","/service-worker.js");q?(function(e){window.fetch(e).then(function(t){404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then(function(e){e.unregister().then(function(){window.location.reload()})}):C(e)}).catch(function(){console.log("No internet connection found. App is running in offline mode.")})}(e),navigator.serviceWorker.ready.then(function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")})):C(e)})}}()}},[[109,2,1]]]);
//# sourceMappingURL=main.5f9c3c4f.chunk.js.map